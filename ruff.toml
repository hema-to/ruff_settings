# =============================================================================
# RUFF CONFIGURATION - shared settings
# =============================================================================
# Documentation: https://docs.astral.sh/ruff/configuration/
# Rules reference: https://docs.astral.sh/ruff/rules/
# =============================================================================

# Require a specific ruff version range for consistent behavior across environments
required-version = ">=0.8.0"

# Match Black's default for consistency
line-length = 88
indent-width = 4

# Minimum Python version to target (override per-repo in pyproject.toml if needed)
target-version = "py311"

# Only add directories not already in ruff's defaults
# Ruff already excludes: .bzr, .direnv, .eggs, .git, .git-rewrite, .hg,
# .ipynb_checkpoints, .mypy_cache, .nox, .pants.d, .pyenv, .pytest_cache,
# .pytype, .ruff_cache, .svn, .tox, .venv, .vscode, __pypackages__,
# _build, buck-out, build, dist, node_modules, site-packages, venv
extend-exclude = [
    "migrations",
    "alembic/versions",
]

# =============================================================================
# LINTER CONFIGURATION
# =============================================================================
[lint]
# Use explicit `select` (not `extend-select`) for clarity and reproducibility
select = [
    # --- Core Python Rules ---
    "F",        # Pyflakes: detects logic errors (undefined names, unused imports)
    "E",        # pycodestyle errors: basic style errors
    "W",        # pycodestyle warnings: style warnings

    # --- Code Quality ---
    "B",        # flake8-bugbear: catches common bugs and design problems
    "C4",       # flake8-comprehensions: better list/dict/set comprehensions
    "SIM",      # flake8-simplify: suggests code simplifications
    "PIE",      # flake8-pie: misc. lints (no pointless statements, etc.)

    # --- Import Management ---
    "I",        # isort: import sorting and organization
    "TID",      # flake8-tidy-imports: import hygiene (banned imports, etc.)

    # --- Modernization ---
    "UP",       # pyupgrade: upgrade syntax for newer Python versions
    "YTT",      # flake8-2020: checks for misuse of sys.version

    # --- Type Checking ---
    "TCH",      # flake8-type-checking: move imports to TYPE_CHECKING blocks
    "PYI",      # flake8-pyi: rules for type stub files

    # --- Async Code ---
    "ASYNC",    # flake8-async: async/await best practices

    # --- Code Hygiene ---
    "T10",      # flake8-debugger: no leftover debugger calls

    # --- Performance ---
    "PERF",     # Perflint: performance anti-patterns
    "FLY",      # flynt: prefer f-strings over .format() and %

    # --- Return/Raise Statements ---
    "RET",      # flake8-return: checks for proper return statements
    "RSE",      # flake8-raise: checks for proper raise statements

    # --- Naming Conventions ---
    "N",        # pep8-naming: naming conventions

    # --- Testing ---
    "PT",       # flake8-pytest-style: pytest best practices

    # --- Executable Files ---
    "EXE",      # flake8-executable: shebang and executable file checks

    # --- Ruff-Specific ---
    "RUF",      # Ruff-specific rules
]

ignore = [
    # --- Line length handled by formatter ---
    "E501",     # line-too-long (formatter handles this best-effort)
    "W505",     # doc line too long

    # --- Overly pedantic rules ---
    "RET504",   # unnecessary-assign: sometimes aids debugging
    "SIM105",   # contextlib.suppress() instead of try-except-pass
    "SIM108",   # if-else-block-instead-of-if-exp: ternary not always clearer

    # --- Performance ---
    "PERF203",  # try-except in loops
    "PERF401",  # list comprehension instead of loop
]

# Rules that should not be auto-fixed (require manual review)
unfixable = [
    "ERA001",   # Don't auto-delete commented code (needs manual review)
    "F401",     # Don't auto-remove unused imports (might be re-exports)
    "F841",     # Don't auto-remove unused variables (might be intentional)
]

# Allow autofix for all enabled rules when `--fix` is passed
fixable = ["ALL"]

# Allow unused variables when underscore-prefixed
dummy-variable-rgx = "^(_+|(_+[a-zA-Z0-9_]*[a-zA-Z0-9]+?))$"

# =============================================================================
# PER-FILE RULE OVERRIDES
# =============================================================================
[lint.per-file-ignores]
# Test files have different requirements
"**/test_*.py" = [
    "S101",     # assert is expected in tests
    "PLR2004",  # Magic values acceptable in tests
    "PT004",    # Fixtures that don't return anything
    "PT013",    # pytest.raises block is fine
    "RUF018",   # Assignment in assert is fine in tests
]
"**/tests/**/*.py" = [
    "S101", "PLR2004", "PT004", "PT013", "RUF018",
]

# __init__.py files often have "unused" imports for re-export
"**/__init__.py" = [
    "F401",     # Unused imports (re-exports)
    "F403",     # Star imports (sometimes used for API surface)
]

# Database seeds/migrations have their own conventions
"**/migrations/**/*.py" = ["N", "E501", "ERA"]
"**/alembic/**/*.py" = ["N", "E501", "ERA"]
"**/seeds/**/*.py" = ["N815", "E501"]
"**/db_seed/**/*.py" = ["N815", "E501"]

# =============================================================================
# ISORT CONFIGURATION
# =============================================================================
[lint.isort]
# Force imports to be sorted within sections
force-sort-within-sections = true
# Split imports from `from` imports
split-on-trailing-comma = true
# Number of lines after imports
lines-after-imports = 2

# =============================================================================
# PYCODESTYLE CONFIGURATION
# =============================================================================
[lint.pycodestyle]
max-doc-length = 88

# =============================================================================
# FLAKE8-BUGBEAR CONFIGURATION
# =============================================================================
[lint.flake8-bugbear]
# Extend the list of functions that are allowed in default arguments
extend-immutable-calls = [
    "fastapi.Depends",
    "fastapi.Query",
    "fastapi.Path",
    "fastapi.Body",
    "fastapi.Header",
    "typer.Option",
    "typer.Argument",
]

# =============================================================================
# FLAKE8-TYPE-CHECKING CONFIGURATION
# =============================================================================
[lint.flake8-type-checking]
# Exempt commonly used runtime-required imports from TC rules
runtime-evaluated-base-classes = [
    "pydantic.BaseModel",
    "sqlalchemy.orm.DeclarativeBase",
]
runtime-evaluated-decorators = [
    "dataclasses.dataclass",
    "pydantic.validate_call",
]

# =============================================================================
# PYLINT CONFIGURATION (if PL rules enabled)
# =============================================================================
[lint.pylint]
max-args = 7
max-branches = 12
max-returns = 6
max-statements = 50

# =============================================================================
# MCCABE COMPLEXITY (if C90 enabled)
# =============================================================================
[lint.mccabe]
max-complexity = 10

# =============================================================================
# PYTEST STYLE CONFIGURATION
# =============================================================================
[lint.flake8-pytest-style]
fixture-parentheses = false
mark-parentheses = false
parametrize-names-type = "tuple"

# =============================================================================
# FORMATTER CONFIGURATION (if using ruff format)
# =============================================================================
[format]
quote-style = "double"
indent-style = "space"
skip-magic-trailing-comma = false
line-ending = "lf"
docstring-code-format = true
docstring-code-line-length = 72
